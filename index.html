<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>NEON DIVE // HYPERDRIVE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Segoe UI', sans-serif; user-select: none; }
        canvas { display: block; }

        /* HUD & UI */
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        
        .hud-text { 
            position: absolute; color: #fff; font-weight: 900; font-style: italic; font-size: 24px;
            text-shadow: 0 0 10px rgba(0,255,255,0.8); letter-spacing: 2px;
        }
        #score-hud { top: 30px; left: 40px; border-left: 5px solid #00ffff; padding-left: 15px; }
        #currency-hud { top: 30px; right: 40px; color: #ffcc00; border-right: 5px solid #ffcc00; padding-right: 15px; text-align: right; }
        #speed-hud { bottom: 30px; left: 40px; font-size: 16px; color: #ff0055; opacity: 0.8; }

        /* BOSS BAR */
        #boss-frame {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%); width: 50%; height: 12px;
            background: rgba(0,0,0,0.8); border: 2px solid #ff0055; display: none;
            box-shadow: 0 0 20px #ff0055;
        }
        #boss-bar { width: 100%; height: 100%; background: #ff0055; transition: width 0.1s; }
        #boss-label { position: absolute; top: -30px; width: 100%; text-align: center; color: #ff0055; font-weight: bold; letter-spacing: 5px; font-size: 18px; }

        /* SCREENS */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(8px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 20; transition: opacity 0.4s;
        }

        h1 { 
            font-size: 100px; margin: 0; color: #fff; 
            text-shadow: 4px 4px 0px #ff0055, -4px -4px 0px #00ffff; 
            font-style: italic; transform: skewX(-10deg);
        }
        
        .btn-main {
            background: transparent; border: 2px solid #fff; color: #fff; padding: 20px 60px;
            font-size: 24px; font-weight: 900; letter-spacing: 3px; cursor: pointer; margin-top: 50px;
            transition: 0.2s; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
        }
        .btn-main:hover { background: #fff; color: #000; box-shadow: 0 0 40px #00ffff; }

        /* SHOP CARDS */
        .upgrade-container { display: flex; gap: 30px; margin-top: 50px; }
        .card {
            background: rgba(20,20,20,0.8); border: 1px solid #444; padding: 25px; width: 220px; text-align: center;
            transition: 0.3s; position: relative; overflow: hidden;
        }
        .card:hover { border-color: #00ffff; transform: translateY(-10px); box-shadow: 0 10px 30px rgba(0,255,255,0.15); }
        .card h3 { color: #00ffff; margin: 0 0 10px 0; }
        .price { font-size: 28px; color: #ffcc00; font-weight: bold; margin: 15px 0; }
        .buy-btn { width: 100%; padding: 12px; background: #333; border: none; color: #fff; font-weight: bold; cursor: pointer; }
        .buy-btn:hover:enabled { background: #00ffff; color: #000; }

        #damage-flash {
            position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;
            transition: background 0.1s; z-index: 5; mix-blend-mode: overlay;
        }

        .hidden { opacity: 0; pointer-events: none; }
    </style>
</head>
<body>

    <div id="damage-flash"></div>

    <div id="ui-layer">
        <div id="score-hud" class="hud-text">SECTOR 01</div>
        <div id="currency-hud" class="hud-text">0 FRAGMENTS</div>
        <div id="speed-hud" class="hud-text">VELOCITY: MACH 1.0</div>
        <div id="boss-frame">
            <div id="boss-label">⚠️ ANOMALY DETECTED ⚠️</div>
            <div id="boss-bar"></div>
        </div>
    </div>

    <div id="menu" class="screen">
        <h1>NEON DIVE</h1>
        <h2 style="color:#ff0055; letter-spacing: 10px; margin-top:-20px;">HYPERDRIVE</h2>
        <button class="btn-main" id="start-btn">ENGAGE</button>
    </div>

    <div id="shop" class="screen hidden">
        <h1 style="font-size: 60px; color: #ff0055;">SYSTEM CRASH</h1>
        <div style="color: #ffcc00; font-size: 20px;">AVAILABLE FRAGMENTS: <span id="shop-frags">0</span></div>
        <div class="upgrade-container">
            <div class="card">
                <h3>MAGNET</h3>
                <div class="lvl">Lvl <span id="lvl-mag">0</span></div>
                <div class="price" id="cost-mag">10</div>
                <button class="buy-btn" onclick="Game.buy('magnet')">INSTALL</button>
            </div>
            <div class="card">
                <h3>CANNONS</h3>
                <div class="lvl">Lvl <span id="lvl-wep">0</span></div>
                <div class="price" id="cost-wep">10</div>
                <button class="buy-btn" onclick="Game.buy('weapon')">INSTALL</button>
            </div>
            <div class="card">
                <h3>SHIELD</h3>
                <div class="lvl" id="lvl-shi">OFFLINE</div>
                <div class="price" id="cost-shi">50</div>
                <button class="buy-btn" onclick="Game.buy('shield')">CHARGE</button>
            </div>
        </div>
        <button class="btn-main" id="respawn-btn" style="margin-top:40px; border-color:#00ff55;">REBOOT</button>
    </div>

    <div id="endgame" class="screen hidden" style="background:#fff;">
        <h1 style="color:#000; text-shadow:none;">TRANSCENDENCE</h1>
        <p style="color:#000; font-weight:bold; letter-spacing:5px;">YOU ARE ETERNAL</p>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // --- GAME LOGIC ---
        const Game = {
            state: 'MENU', sector: 1, frags: 0, 
            baseSpeed: 0.8, currentSpeed: 0.8,
            targetLane: 0, laneX: [-5, 0, 5],
            upgrades: { magnet: 0, weapon: 0, shield: false },
            
            getCost: (t) => t==='shield' ? 50 : Math.floor(10 * Math.pow(1.5, Game.upgrades[t])),
            buy: (t) => {
                const c = Game.getCost(t);
                if(Game.frags >= c) {
                    if(t==='shield') { if(Game.upgrades.shield) return; Game.upgrades.shield=true; }
                    else Game.upgrades[t]++;
                    Game.frags -= c;
                    AudioSys.play('buy'); Game.save(); UI.updateShop();
                }
            },
            save: () => localStorage.setItem('neon_hyper', JSON.stringify({f:Game.frags, u:Game.upgrades})),
            load: () => {
                const d = JSON.parse(localStorage.getItem('neon_hyper')||'{}');
                Game.frags=d.f||0; Game.upgrades=d.u||{magnet:0, weapon:0, shield:false};
            }
        };
        window.Game = Game;

        // --- AUDIO ---
        const AudioSys = {
            ctx: null,
            init() {
                this.ctx = new (window.AudioContext||window.webkitAudioContext)();
                this.gain = this.ctx.createGain();
                this.gain.gain.value = 0.2;
                this.gain.connect(this.ctx.destination);
                // Procedural Drum Loop
                let beat = 0;
                setInterval(() => {
                    if(Game.state !== 'RUN' && Game.state !== 'BOSS') return;
                    const t = this.ctx.currentTime;
                    // Kick
                    if(beat % 4 === 0) this.tone(100, 0.01, t, 0.2, 'sine');
                    // Bass
                    if(beat % 2 !== 0) this.tone(50, 0.01, t, 0.2, 'sawtooth', 0.1);
                    // Hat
                    if(beat % 1 === 0) this.noise(t);
                    beat++;
                }, 150); // Fast BPM
            },
            tone(f, endF, t, len, type, vol=1) {
                const o=this.ctx.createOscillator(); o.type=type;
                const g=this.ctx.createGain();
                o.frequency.setValueAtTime(f, t); o.frequency.exponentialRampToValueAtTime(endF, t+len);
                g.gain.setValueAtTime(vol, t); g.gain.exponentialRampToValueAtTime(0.01, t+len);
                o.connect(g); g.connect(this.gain); o.start(t); o.stop(t+len);
            },
            noise(t) {
                const bSize = this.ctx.sampleRate * 0.05;
                const b = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                const d = b.getChannelData(0);
                for(let i=0; i<bSize; i++) d[i] = Math.random() * 2 - 1;
                const src = this.ctx.createBufferSource(); src.buffer = b;
                const g = this.ctx.createGain(); g.gain.value = 0.1;
                src.connect(g); g.connect(this.gain); src.start(t);
            },
            play(id) {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                if(id==='buy') this.tone(600, 800, t, 0.2, 'square');
                if(id==='coin') this.tone(1200, 1800, t, 0.1, 'sine', 0.5);
                if(id==='crash') this.tone(100, 10, t, 0.5, 'sawtooth', 0.5);
                if(id==='shoot') this.tone(400, 100, t, 0.1, 'square', 0.1);
            }
        };

        // --- GRAPHICS & PARTICLES ---
        const Scene = {
            init() {
                this.scene = new THREE.Scene();
                this.scene.fog = new THREE.FogExp2(0x000000, 0.03);
                this.camera = new THREE.PerspectiveCamera(90, window.innerWidth/window.innerHeight, 0.1, 1000);
                this.camera.position.set(0, 3, 6);
                
                this.renderer = new THREE.WebGLRenderer({ antialias: false, powerPreference: "high-performance" });
                this.renderer.setSize(window.innerWidth, window.innerHeight);
                this.renderer.toneMapping = THREE.ACESFilmicToneMapping; // Balanced brightness
                this.renderer.toneMappingExposure = 1.0;
                document.body.appendChild(this.renderer.domElement);
                
                const renderPass = new RenderPass(this.scene, this.camera);
                this.bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
                this.bloom.strength = 1.5; this.bloom.radius = 0.5; this.bloom.threshold = 0.1;
                
                this.composer = new EffectComposer(this.renderer);
                this.composer.addPass(renderPass);
                this.composer.addPass(this.bloom);
                
                window.onresize = () => {
                    this.camera.aspect = window.innerWidth/window.innerHeight;
                    this.camera.updateProjectionMatrix();
                    this.renderer.setSize(window.innerWidth, window.innerHeight);
                    this.composer.setSize(window.innerWidth, window.innerHeight);
                };

                this.createStarfield();
            },
            createStarfield() {
                // WARP SPEED PARTICLES
                const geo = new THREE.BufferGeometry();
                const pos = [];
                for(let i=0; i<2000; i++) {
                    pos.push((Math.random()-0.5)*100, (Math.random()-0.5)*50, (Math.random()-0.5)*200);
                }
                geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
                const mat = new THREE.PointsMaterial({color: 0xffffff, size: 0.15});
                this.stars = new THREE.Points(geo, mat);
                this.scene.add(this.stars);
            },
            animateStars() {
                const pos = this.stars.geometry.attributes.position.array;
                const speed = Game.currentSpeed * 2.5; // Stars move faster than floor
                for(let i=2; i<pos.length; i+=3) {
                    pos[i] += speed;
                    if(pos[i] > 20) pos[i] = -200; // Reset
                }
                this.stars.geometry.attributes.position.needsUpdate = true;
            }
        };

        // --- INFINITE TERRAIN ---
        const Terrain = {
            init() {
                // Moving the texture, not the mesh, for infinite scrolling
                const geo = new THREE.PlaneGeometry(200, 200, 60, 60);
                geo.rotateX(-Math.PI/2);
                
                this.uniforms = { 
                    time: { value: 0 }, 
                    scroll: { value: 0 } // The key to infinite movement
                };

                const mat = new THREE.ShaderMaterial({
                    uniforms: this.uniforms,
                    vertexShader: `
                        varying vec2 vUv; uniform float time;
                        void main() {
                            vUv = uv; vec3 p = position;
                            // Synthwave Curvature
                            float curve = pow(p.z * 0.05, 2.0);
                            p.y -= curve; 
                            gl_Position = projectionMatrix * modelViewMatrix * vec4(p, 1.0);
                        }
                    `,
                    fragmentShader: `
                        varying vec2 vUv; uniform float time; uniform float scroll;
                        void main() {
                            // SCROLLING GRID LOGIC
                            vec2 gridUV = vUv * 40.0;
                            gridUV.y += scroll; // Move texture
                            float grid = step(0.95, fract(gridUV.x)) + step(0.95, fract(gridUV.y));
                            
                            vec3 col = mix(vec3(0.05, 0.0, 0.1), vec3(0.0, 1.0, 1.0), grid);
                            float fog = smoothstep(0.0, 0.8, vUv.y); // Fog fade at back
                            gl_FragColor = vec4(col * fog, 1.0);
                        }
                    `,
                    transparent: true
                });
                const mesh = new THREE.Mesh(geo, mat);
                mesh.position.y = -3;
                Scene.scene.add(mesh);
            }
        };

        const Player = {
            init() {
                this.mesh = new THREE.Group();
                const mat = new THREE.MeshStandardMaterial({color: 0x111111, emissive: 0x00ffff, emissiveIntensity: 0.8, roughness: 0.2});
                
                // Ship Body
                const body = new THREE.Mesh(new THREE.ConeGeometry(0.5, 3, 3), mat);
                body.rotation.x = Math.PI/2; body.scale.z = 0.5;
                this.mesh.add(body);
                
                // Wings
                const wings = new THREE.Mesh(new THREE.BoxGeometry(3, 0.1, 1.5), mat);
                wings.position.z = 0.5;
                this.mesh.add(wings);

                // Shield
                this.shield = new THREE.Mesh(new THREE.IcosahedronGeometry(2, 2), new THREE.MeshBasicMaterial({color:0x00ff00, wireframe:true, transparent:true, opacity:0}));
                this.mesh.add(this.shield);

                // Glow Engine
                const light = new THREE.PointLight(0x00ffff, 2, 8);
                light.position.set(0,0,2);
                this.mesh.add(light);

                Scene.scene.add(this.mesh);
                this.cx = 0; this.tilt = 0;
            },
            update(dt) {
                const tx = Game.laneX[Game.targetLane+1];
                this.cx += (tx - this.cx) * 12 * dt; // Snappy movement
                this.mesh.position.x = this.cx;
                this.tilt += (-(this.mesh.position.x - tx)*0.8 - this.tilt) * 10 * dt;
                this.mesh.rotation.z = this.tilt;
                
                // Shield pulse
                if(Game.upgrades.shield) { this.shield.rotation.y += dt; this.shield.material.opacity = 0.3 + Math.sin(Date.now()*0.01)*0.1; }
                else this.shield.material.opacity = 0;
            }
        };

        const World = {
            objs: [], particles: [], boss: null, spawnTimer: 0,
            
            spawn() {
                const lane = Math.floor(Math.random()*3);
                const x = Game.laneX[lane];
                const isCoin = Math.random() > 0.7; // 30% Coin
                
                let m;
                if(isCoin) {
                    m = new THREE.Mesh(new THREE.OctahedronGeometry(0.5), new THREE.MeshBasicMaterial({color: 0xffcc00, wireframe:true}));
                    m.add(new THREE.PointLight(0xffcc00, 1, 3));
                    m.userData = {type:'coin'};
                } else {
                    const h = 2 + Math.random()*3;
                    const geo = new THREE.BoxGeometry(2, h, 2);
                    const mat = new THREE.MeshStandardMaterial({color: 0x000000, emissive: 0xff0055, emissiveIntensity: 0.5});
                    m = new THREE.Mesh(geo, mat);
                    m.position.y = h/2 - 2; // Sit on grid
                    
                    // Add "Neon Edge"
                    const edge = new THREE.LineSegments(new THREE.EdgesGeometry(geo), new THREE.LineBasicMaterial({color:0xff0055}));
                    m.add(edge);
                    m.userData = {type:'obs'};
                }
                m.position.x = x;
                m.position.z = -120;
                Scene.scene.add(m);
                this.objs.push(m);
            },
            
            explode(pos, color) {
                for(let i=0; i<20; i++) {
                    const m = new THREE.Mesh(new THREE.BoxGeometry(0.2,0.2,0.2), new THREE.MeshBasicMaterial({color:color}));
                    m.position.copy(pos);
                    // Random explosion velocity
                    const v = new THREE.Vector3((Math.random()-0.5)*10, (Math.random()-0.5)*10, (Math.random()-0.5)*10);
                    Scene.scene.add(m);
                    this.particles.push({m, v, life:1.0});
                }
            },

            update(dt) {
                // SPAWN LOGIC: Timer based, not random chance
                this.spawnTimer += dt;
                const spawnRate = Math.max(0.3, 1.0 - (Game.currentSpeed * 0.5)); // Faster speed = faster spawns
                if(this.spawnTimer > spawnRate) {
                    this.spawn();
                    this.spawnTimer = 0;
                }

                const spd = Game.currentSpeed;
                
                // Objects
                for(let i=this.objs.length-1; i>=0; i--) {
                    const o = this.objs[i];
                    o.position.z += spd; // Move towards camera
                    
                    // Magnet
                    if(o.userData.type==='coin' && o.position.distanceTo(Player.mesh.position) < 5+Game.upgrades.magnet*2) {
                        o.position.lerp(Player.mesh.position, dt*8);
                    }

                    // Collision
                    if(o.position.distanceTo(Player.mesh.position) < 1.8) {
                        if(o.userData.type==='coin') {
                            Game.frags++; AudioSys.play('coin'); UI.hud();
                            this.explode(o.position, 0xffcc00);
                        } else {
                            Main.hit();
                        }
                        Scene.scene.remove(o); this.objs.splice(i,1);
                    } else if (o.position.z > 10) {
                        Scene.scene.remove(o); this.objs.splice(i,1);
                    }
                }

                // Particles
                for(let i=this.particles.length-1; i>=0; i--) {
                    const p = this.particles[i];
                    p.m.position.addScaledVector(p.v, dt);
                    p.life -= dt * 2;
                    p.m.scale.setScalar(p.life);
                    p.m.rotation.x += dt*5;
                    if(p.life <= 0) { Scene.scene.remove(p.m); this.particles.splice(i,1); }
                }
                
                // BOSS LOGIC OMITTED FOR BREVITY IN HYPERDRIVE (Focus on Runner)
                // Re-added simplified boss
                if(this.boss) {
                    this.boss.m.position.x = Math.sin(Date.now()*0.002)*8;
                    // Boss logic handled in Main loop structure if state is BOSS
                }
            }
        };

        const Main = {
            init() {
                Game.load(); Scene.init(); Terrain.init();
                document.getElementById('start-btn').onclick=()=>{AudioSys.init();this.run()};
                document.getElementById('respawn-btn').onclick=()=>{this.run()};
                document.addEventListener('keydown', e=>{
                    if(e.key=='a'||e.key=='ArrowLeft') Game.targetLane=Math.max(-1,Game.targetLane-1);
                    if(e.key=='d'||e.key=='ArrowRight') Game.targetLane=Math.min(1,Game.targetLane+1);
                });
                this.loop();
            },
            run() {
                Game.state='RUN'; Game.currentSpeed = Game.baseSpeed;
                Player.init(); UI.screen(null); UI.hud();
                World.objs.forEach(o=>Scene.scene.remove(o)); World.objs=[];
            },
            hit() {
                if(Game.upgrades.shield) {
                    Game.upgrades.shield=false; AudioSys.play('crash');
                    document.getElementById('damage-flash').style.background = "rgba(0,255,0,0.5)";
                    setTimeout(()=>document.getElementById('damage-flash').style.background="transparent",100);
                } else {
                    Game.state='SHOP'; AudioSys.play('crash');
                    Scene.scene.remove(Player.mesh);
                    World.explode(Player.mesh.position, 0x00ffff);
                    document.getElementById('damage-flash').style.background = "rgba(255,0,0,0.5)";
                    setTimeout(()=>{
                        document.getElementById('damage-flash').style.background="transparent";
                        UI.screen('shop');
                    }, 500);
                }
            },
            loop() {
                requestAnimationFrame(()=>this.loop());
                const dt = 0.016;
                const t = Date.now()*0.001;
                
                // Shader Updates
                Terrain.uniforms.time.value = t;
                
                if(Game.state==='RUN') {
                    // SPEED UP OVER TIME
                    Game.currentSpeed += 0.0002; 
                    
                    // SCROLL FLOOR
                    Terrain.uniforms.scroll.value += Game.currentSpeed * 0.5; // SCROLLS THE TEXTURE

                    Player.update(dt);
                    World.update(dt);
                    Scene.animateStars();
                    
                    // Update HUD
                    document.getElementById('speed-hud').innerText = "VELOCITY: MACH " + Game.currentSpeed.toFixed(2);
                    
                    // Simple Sector Logic
                    if(Math.floor(Terrain.uniforms.scroll.value) % 100 === 0) {
                        Game.sector++; UI.hud();
                        if(Game.sector > 50) { Game.state='END'; UI.screen('endgame'); }
                    }
                }
                
                Scene.composer.render();
            }
        };

        const UI = {
            hud:()=>{
                document.getElementById('score-hud').innerText = "SECTOR "+Game.sector;
                document.getElementById('currency-hud').innerText = Game.frags+" FRAGMENTS";
            },
            screen:(id)=>{
                document.querySelectorAll('.screen').forEach(e=>e.classList.add('hidden'));
                if(id){document.getElementById(id).classList.remove('hidden');if(id==='shop')this.shop();}
            },
            shop:()=>{
                document.getElementById('shop-frags').innerText = Game.frags;
                document.getElementById('lvl-mag').innerText = Game.upgrades.magnet;
                document.getElementById('lvl-wep').innerText = Game.upgrades.weapon;
                document.getElementById('cost-mag').innerText = Game.getCost('magnet');
                document.getElementById('cost-wep').innerText = Game.getCost('weapon');
                const sl=document.getElementById('lvl-shi');
                sl.innerText=Game.upgrades.shield?"ACTIVE":"OFFLINE"; sl.style.color=Game.upgrades.shield?"#00ff00":"#888";
            },
            updateShop:function(){this.shop()}
        };

        Main.init();
    </script>
</body>
</html>
